{% extends 'layout.html.twig' %}

{% block beforecontainer %}
{% endblock %}
{% block aftercontainer %}
    <div class="center-align">
        {% image '@AppBundle/Resources/public/img/cute-elefan.png' %}
            <img class="responsive-img" src="{{ asset_url }}" alt="elefan"/>
        {% endimage %}
    </div>
{% endblock %}
{% block content %}
    {% if is_granted("IS_AUTHENTICATED_REMEMBERED") %}
        <div class="center">
        <div class="row">
            <div class="col s12">
                <h3 class="header">
                    Bonjour {% if app.user.beneficiary %}{{ app.user.beneficiary.firstname }}<br>#{{ app.user.beneficiary.membership.memberNumber }}{% else %}{{ app.user.username }}{% endif %}
                </h3>
            </div>
            {% if is_granted("ROLE_SUPER_ADMIN") %}
                <div class="col s12">
                    <span class="orange-text">&lt;warning&gt;</span>
                    <span>With great power comes great responsibility</span>
                    <span class="orange-text">&lt;/warning&gt;</span>
                </div>
            {% endif %}
            {% if app.user.beneficiary %}
                <div class="col s12">
                    <p>Bienvenue sur ton espace personnel à {{ project_name }}.
                        {% if app.user.beneficiary.membership | can_register and app.user.beneficiary.membership.registrations | length %}
                            <br>
                            <br>
                            {% if not app.user.beneficiary.membership | uptodate %}
                                Ton adhésion a expiré le {{ "now"|date_modify((app.user.beneficiary.membership | remainder | date("%R%a"))~" days")| date_fr_long }}.<br>
                            {% endif %}
                            <a href="{{ path("user_self_register") }}" class="waves-effect waves-light light-green btn"><i
                                                                       class="material-icons left">card_membership</i>Je ré-adhère en ligne</a>
                            <br>
                            <br>
                        {% elseif not app.user.beneficiary.membership.registrations | length %}
                            <br>
                            <br>
                            Il est temps d'adhérer.<br>
                            <a href="{{ path("user_self_register") }}" class="waves-effect waves-light light-green btn">
                                <i class="material-icons left">card_membership</i>J'adhère en ligne
                            </a>
                            <br>
                            <br>
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>

        <div class="announcement">{{ dynamicContent | markdown | raw }}</div>

        {% if app.user.beneficiary %}{# not only admin ? #}
            <div class="row">
                {% if app.user.beneficiary.membership | uptodate %}
                    <div class="col s12 xl6">
                        <div class="homebox">
                            <h5><span class="white">Mon Compte</span></h5>
                                {{ render(controller("AppBundle:Booking:homepageDashboard")) }}
                                <a href="{{ path("fos_user_profile_show") }}" class="waves-effect waves-light blue-grey btn">
                                    <i class="material-icons left">settings</i>
                                    Gérer mon compte
                                </a>
                                {% if(display_freeze_account) %}
                                    <br>{% include "member/_partial/frozen.html.twig" with { member: app.user.beneficiary.membership  } %}
                                {% endif %}
                                {% if(display_swipe_cards_settings) %}
                                    <br>{% include "member/_partial/swipe_card.html.twig" with { member: app.user.beneficiary.membership, showBadgeImage: false } %}
                                {% endif %}
                        </div>
                    </div>
                    <div class="col s12 xl6">
                        <div class="homebox">
                            <h5><span class="white">Mes Créneaux</span></h5>
                            {{ render(controller("AppBundle:Booking:homepageShifts1")) }}
                        </div>
                    </div>
                {% endif %}
                <div class="col s12 m12 l6 xl4">
                    <div class="homebox">
                        <h5><span class="white">En ce moment à {{ project_name }}</span></h5>
                        <a href="{{ path("process_update_list") }}" class="btn blue-grey" id="news_home_button" style="position: relative">
                            <i class="material-icons left" >info</i>Les nouveautés
                            <span class="bubble_counter red white-text" style="display:none;">{{ app.user.beneficiary | last_shift_date | count_updates_list_from_date}}</span>
                        </a>
                        <script>
                            defer(function () {
                                var cookie_data = myCookieInit({'last_processupdates_check' : "{{  app.user.beneficiary | last_shift_date | date_w3c }}".replace('+','_')});
                                jQuery.ajax(process_update_count_unread_url,{
                                    data: {date: cookie_data.last_processupdates_check.replace('_','+')},
                                    method: "post",
                                    dataType: "json"
                                }).done(function (data, textStatus, jqXHR) {
                                    if (textStatus == "success"){
                                        if (data.count > 0){
                                            $('#news_home_button').find('.bubble_counter').html(data.count).show();
                                            $('head title').prepend('('+data.count+') ');
                                        }
                                    }
                                });
                            });
                        </script>

                        <div class="row">
                            {% if events | length > 0 %}
                                <h5>Les événements</h5>
                                {% for event in events %}
                                    {% include "default/event/_event.html.twig" with { event: event } %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col s12">
                    <div class="homebox">
                        <h5><span class="white">Les Conseil d'administration</span></h5>
                        {% for college, instances in caByCollege %}
                            <h6><span class="white">Collèges {{ college }}</span></h6>
                            <div class="row" style="display: flex;flex-wrap: wrap;">
                                {% for instance in instances %}
                                    <div class="col s12 m6">
                                        <div class="card">
                                            <div class="card-content left-align">
                                                <span class="card-title">
                                                    {{ instance.name }}
                                                </span>
                                                <p class="valign-wrapper">
                                                    {% for member in instance.getBeneficiaries %}
                                                        {{ member }}, 
                                                    {% endfor %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col s12">
                    <div class="homebox">
                        <h5><span class="white">Les Commissions</span></h5>
                        Si tu veux en savoir plus sur les commissions, tu trouveras toutes les informations utiles ci-dessous !
                        <div class="row" style="display: flex;flex-wrap: wrap;">
                            {% for commission in commissions %}
                                <div class="col s12 m6">
                                    <div class="card">
                                        <div class="card-content left-align">
                                            <span class="card-title">
                                                {{ commission.name }}
                                                <div class="right">
                                                    <a href="mailto:{{ commission.email | email_encode | raw }}"><i class="material-icons">question_answer</i></a>
                                                    <a href="mailto:{{ commission.email | email_encode | raw }}"><i class="material-icons">email</i></a>
                                                </div>
                                            </span>
                                            <p class="valign-wrapper"><i class="material-icons tiny">date_range</i>&nbsp;<span>{{ commission.getNextMeetingDate|date('d/m/y à H:i') }}</span></p>
                                            <p class="valign-wrapper"><i class="material-icons tiny">people</i>&nbsp;<span>{{ commission.getBeneficiaries|length }} membres</span></p>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            <div class="col s12">
                                <a href="{{ path("tasks_list") }}" class="waves-effect waves-light btn blue-grey"><i class="material-icons left">list</i>Taches en cours</a><br>
                            </div>
                            {% for com in app.user.beneficiary.ownedCommissions %}
                                <div class="col s12">
                                    <a href="{{ path("commission_edit",{'id': com.id }) }}" class="waves-effect waves-light btn blue-grey">Gérer la commission {{ com.name }}</a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% if app.user.beneficiary.membership | uptodate %}
                    {% if is_granted("access_tools",app.user) %}
                        <div class="col s12">
                            <div class="homebox">
                                <h5><span class="white"><i class="material-icons">build</i>&nbsp;Ambassadeur</span></h5>
                                <a href="{{ path("user_office_tools") }}" class="waves-effect waves-light btn teal">
                                    <i class="material-icons left">folder_shared</i>adhésion / ré-adhésion</a>
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        {% endif %}
    {% else %}
    <div class="section no-pad-bot" id="index-banner">
        <div class="container">
            <br><br>
            <h3 class="header center orange-text">Mon compte à {{ project_name }}</h3>
            <div class="row center">
                <p class="col s12 light">Bienvenue sur l'espace membre</p>
            </div>
            <div class="row center">
                <a href="{{ path('fos_user_security_login') }}" class="btn-large waves-effect waves-light"><i
                            class="material-icons left">lock_outline</i>Se connecter</a>
            </div>
            <div class="row center">
                <p class=" col s12 light"> Pas encore d'identifiant ?
                    <a href="{{ path('find_me') }}" class="orange-text">Créer mon compte</a>
                </p>
            </div>
        </div>
        </div>
        {#<h4 class="header center gray-text">Planning</h4>#}
        {% include "booking/_partial/list.html.twig" with { bucketsByDay: bucketsByDay } %}
        <div>
    </div>
    {% endif %}
{% endblock %}

{% block stylesheets %}
{% endblock %}
{% block javascripts %}
    <script>
        jQuery(function () {
            $(".collapsible .modal-trigger").on('click', function (e) {
                e.preventDefault();
            });
        })
        {% if not is_granted("IS_AUTHENTICATED_REMEMBERED") %}
        var barcode_submit_url = "{{ path('check') }}";
        {% endif %}
    </script>
    <script type="text/javascript">
        jQuery(function($) {
            $.fn.hasScrollBar = function() {
                return this.get(0).scrollHeight > this.innerHeight();
            }
        });
        $(document).ready(function(){
        $('.carousel.carousel-slider').carousel({
            fullWidth: true,
                    shift: 10,
        });
    });

        $(document).ready(function(){
            if (!$('#scrollwindow').hasScrollBar()) {
                $('#scrollarrow').hide();
            }
        });
        $('#scrollwindow').scroll(function(){
            if ($(this).scrollTop() < 20) {
                $('#scrollarrow').show();
            }else{
                $('#scrollarrow').hide();
            }
        });

        // move next carousel
        $('.moveNextCarousel').click(function(e){
            e.preventDefault();
            e.stopPropagation();
            $('.carousel').carousel('next');
        });

        // move prev carousel
        $('.movePrevCarousel').click(function(e){
            e.preventDefault();
            e.stopPropagation();
            $('.carousel').carousel('prev');
        });
    </script>
    {% if not is_granted("IS_AUTHENTICATED_REMEMBERED") %}
        <script src="{{ asset('bundles/app/js/barcode.js') }}"></script>
    {% endif %}
{% endblock %}
